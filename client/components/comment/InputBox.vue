<template>
  <section>
    <el-input
      v-model="inputValue"
      type="textarea"
      :rows="3"
      placeholder="写下你的评论...（支持MarkDown，被你@的用户会收到邮件通知）"
      resize="none"
      :autosize="{minRows: 3, maxRows: 6}"
      @focus="onInputFocus"
    />
    <transition name="fade">
      <div v-show="isMainInputBox ? isButtonsShow : true">
        <!-- 填写用户信息区域 -->
        <el-row v-if="!hasUserCache || isEditUserCache" type="flex">
          <el-col :span="6"><el-input v-model="fromWhom.name" placeholder="称呼 *" /></el-col>
          <el-col :span="6"><el-input v-model="fromWhom.email" placeholder="邮箱 *" /></el-col>
          <el-col :span="8">
            <el-input v-model="fromWhom.site" placeholder="个人网址">
              <el-select slot="prepend" v-model="fromWhom.sitePrefix" placeholder="请选择">
                <el-option label="http://" value="http://" />
                <el-option label="https://" value="https://" />
              </el-select>
            </el-input>
          </el-col>
          <el-col v-if="!isEditUserCache" :span="4">
            <el-checkbox v-model="rememberMe">记住我</el-checkbox>
          </el-col>
          <el-col v-else :span="4">
            <el-button type="success" plain @click="updateUserCache"><i class="el-icon-check" /></el-button>
          </el-col>
        </el-row>
        <!--  -->
        <el-button round>😊</el-button>
        <span @click="onCancel">取消</span>
        <el-button type="success" round @click="onSubmit">发送</el-button>
        <!-- 修改用户信息区域 -->
        <div v-if="hasUserCache">
          <strong>{{ fromWhom.name }}</strong>
          <el-dropdown>
            <span class="el-dropdown-link">
              <i class="el-icon-setting" />
              账户设置
              <i class="el-icon-arrow-down el-icon--right" />
            </span>
            <el-dropdown-menu slot="dropdown">
              <el-dropdown-item @click.native="isEditUserCache = true">修改信息</el-dropdown-item>
              <el-dropdown-item @click.native="clearUserCache">清空信息</el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
        </div>
      </div>
    </transition>
  </section>
</template>

<script>
export default {
  props: {
    isMainInputBox: {
      type: Boolean,
      required: true,
    },
    inputPrefix: {
      type: String,
      default:''
    }
  },

  data () {
    return {
      inputValue: '',
      isButtonsShow: false,

      // 用户相关
      hasUserCache: false,
      isEditUserCache: false,
      userAvatar: null,
      rememberMe: false,
      fromWhom: {
        name: '',
        email: '',
        sitePrefix: 'http://',
        site: ''
      },

      // 用户信息验证
      regExps: {
        email: /\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/,
        site: /^[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/
      }
    }
  },

  watch: {
    inputPrefix: function (newValue, oldValue) {
      return this.inputValue = newValue
    }
  },

  mounted () {
    this.readUserCache()
  },



  methods: {
    // 读取保存在本地的 用户信息
    readUserCache () {
      if (window.localStorage) {
        let fromWhom = window.localStorage.getItem('user_info')
        if (fromWhom) {
          this.fromWhom = JSON.parse(fromWhom)
          this.hasUserCache = true
          // this.updateUserGravatar()
        }
      }
    },

    updateUserCache () {
      this.checkUserInfo()
      window.localStorage.setItem('user_info', JSON.stringify(this.fromWhom))
      this.isEditUserCache = false
      this.$message.success('信息修改成功')
    },
    clearUserCache () {
      window.localStorage.removeItem('user_info')
    },
    checkUserInfo () {
      let warning = this.$message.warning
      if(!this.fromWhom.name) return warning('请输入名字')
      if(!this.fromWhom.email) return warning('请输入邮箱')
      if(!this.regExps.email.test(this.fromWhom.email)) return warning('邮箱不合法')
      if(this.fromWhom.site && !this.regExps.site.test(this.fromWhom.site)) return warning('网址不合法')
    },



    // 输入框获得焦点时的处理函数
    onInputFocus () {
      this.isButtonsShow = true
    },
    // 点击输入框“取消”按钮的处理函数
    onCancel () {
      this.$emit('hideSubInputBox')
      this.isButtonsShow = false
      this.inputValue = ''
    },
    // 点击输入框“发送”按钮的处理函数
    onSubmit: async function () {
      if(this.isMainInputBox) {
        var articleId = window.location.pathname.split('/')[2]
        let dataObj = {    // 定义父评论需要保存的数据对象
          content: this.inputValue,
          fromWhom: this.fromWhom,
          articleId
        }
        var {data} = await this.$axios.post('/api/comments', dataObj)
        this.isButtonsShow = false
      } else {
        let isReplyToParent = this.$parent.isReplyToParent
        let content =
          isReplyToParent   // 将子评论内容中的”@xxx“字段去除，便于后续数据操作和页面显示。
          ? this.inputValue
          : this.inputValue.replace('@' + this.$parent.currentSubComment.fromWhom.name, '').trim()
        let toWhom =
          isReplyToParent
          ? this.$parent.comment.fromWhom
          : this.$parent.currentSubComment.fromWhom
        let dataObj = {
          _id: this.$parent.comment._id,
          fromWhom: this.fromWhom,
          toWhom,
          content,
          isReplyToParent
        }
        var {data} = await this.$axios.patch('/api/comments', dataObj)
        this.$emit('hideSubInputBox')
      }
      this.inputValue = ''
      let {success, message} = data
      if (success) {
        this.$message.success(message)
        this.$store.dispatch('comments/fetchCommentList', articleId)  // 更新vuex中commentList的数据
        if (this.rememberMe) {
          this.$store.dispatch('')
          this.hasUserCache = true
        }
      } else this.$message.error(message)
    }

  }
}
</script>
